{"version":3,"file":"ttspassage.min.js","sources":["../src/ttspassage.js"],"sourcesContent":["define(['jquery','core/log','core/str','core/templates','mod_solo/pollyhelper'], function($,log,str,templates,polly) {\n    \"use strict\"; // jshint ;_;\n\n\n    log.debug('Solo TTS Passage: initialising');\n\n    return{\n        //controls\n        controls: {},\n        checking: '... checking ...',\n\n        //init the module\n        init: function(uniqid){\n            this.uniqid=uniqid;\n            this.ready=false;\n            this.thesentence_number =0;\n            this.lettered= false;\n            this.stoporpause='pause';\n            \n            //common selectors\n            this.sentenceselector = '#' + this.uniqid + '_textblock span.tbr_sentence';\n            \n            //init other stuff\n            this.init_strings();\n            this.register_controls();\n            this.register_events();\n            this.init_polly();\n        },\n\n        init_strings: function(){\n            var that =this;\n            //not used here .. just for later use\n            str.get_string('checking','mod_solo').done(function(s){that.checking=s;});\n        },\n\n        init_polly: function(){\n            var token = this.controls.ttspassagecont.attr('data-token');\n            var region = this.controls.ttspassagecont.attr('data-region');\n            var owner = 'poodll';\n            polly.init(token, region,owner);\n        },\n\n        //load all the controls so we do not have to do it later\n        register_controls: function(){\n            this.controls.ttspassagecont = $('#' + this.uniqid + '_ttspassageplayer');\n            this.controls.showttspassagebtn =  $('#' + this.uniqid + '_showttspassagebtn');\n            this.controls.selftranscript = $(\"textarea[name='selftranscript']\");\n            this.controls.ttssentencecont= $('#' + this.uniqid + '_ttssentencecont .tbr_innerdiv');\n            \n            //audio player declarations\n            this.controls.aplayer = $('#' +  this.uniqid + '_ttspassageaudio');\n            this.controls.theaplayerbtn = $('#' +  this.uniqid + '_ttspassagebutton');\n            this.controls.textblock = $('#' +  this.uniqid + '_textblock');\n            this.controls.fa = $('#' +  this.uniqid + '_ttspassagebutton .fa');\n\n            //passage lines\n            this.controls.passagelines = $(this.sentenceselector);\n        },\n\n        //attach the various event handlers we need\n        register_events: function() {\n            var that = this;\n            that.controls.showttspassagebtn.click(function(e){\n                that.markup_and_show();\n                return false;\n            });\n\n            //AUDIO PLAYER events\n            that.controls.aplayer[0].addEventListener('ended', function(){\n                if(that.thesentence_number< that.controls.passagelines.length -1){\n                    that.thesentence_number++;\n                    that.doplayaudio(that.thesentence_number);\n                }else{\n                    that.dehighlight_all();\n                    that.controls.fa.removeClass('fa-stop');\n                    that.controls.fa.addClass('fa-volume-up');\n                    that.thesentence_number=0;\n                    that.controls.aplayer.removeAttr('src');\n                }\n            });\n\n            //handle audio player button clicks\n            that.controls.theaplayerbtn.click(function(){\n                if(!that.controls.aplayer[0].paused && !that.controls.aplayer[0].ended){\n                    that.controls.aplayer[0].pause();\n                    if(that.stoporpause=='stop'){\n                        that.controls.aplayer[0].load();\n                        that.thesentence_number=0;\n                    }\n                    that.controls.fa.removeClass('fa-stop');\n                    that.controls.fa.addClass('fa-volume-up');\n\n                    //if paused and in limbo no src state\n                }else if(that.controls.aplayer[0].paused && that.controls.aplayer.attr('src')){\n                    that.controls.aplayer[0].play();\n                    that.controls.fa.removeClass('fa-volume-up');\n                    that.controls.fa.addClass('fa-stop');\n                    //play\n                }else{\n                    if(!that.lettered){\n                        //spanify_text_passage();\n                        that.lettered=true;\n                    }//end of if lettered\n                    if(that.stoporpause=='stop'){\n                        that.thesentence_number=0;\n                    }\n                    that.doplayaudio(that.thesentence_number);\n                    that.controls.fa.removeClass('fa-volume-up');\n                    that.controls.fa.addClass('fa-stop');\n                }//end of if paused ended\n            });\n\n            //handle sentence clicks\n            $('#' + that.uniqid + '_textblock  .tbr_innerdiv').on('click', '.tbr_sentence',function(){\n                that.controls.aplayer[0].pause();\n                var sentenceindex = $(this).attr('data-sentenceindex');\n                that.controls.fa.removeClass('fa-volume-up');\n                that.controls.fa.addClass('fa-stop');\n                that.thesentence_number = sentenceindex;\n                that.doplayaudio(sentenceindex);\n            });\n\n            \n        },//end of register events\n\n        //FUNCTION:  unhighlight a sentence as active\n        dehighlight_all: function(){\n            this.controls.passagelines.removeClass('passageplayer_activesentence');\n        },\n\n        //FUNCTION:  highlight a sentence as active\n        highlight_sentence: function(thesentence){\n            this.controls.passagelines.removeClass('passageplayer_activesentence');\n            $(this.controls.passagelines[thesentence]).addClass('passageplayer_activesentence');\n            // $(sentenceselector + '[data-sentenceindex=' + thesentence + ']').addClass('passageplayer_activesentence');\n        },\n\n        //FUNCTION: play a single sentence and mark it active for display purposes\n        doplayaudio: function(thesentence){\n            log.debug(thesentence);\n            this.highlight_sentence(thesentence);\n            this.controls.aplayer.attr('src',$(this.controls.passagelines[thesentence]).data('audiourl'));\n            this.controls.aplayer[0].play();\n        },\n\n        markup_and_show: function(){\n            var that = this;\n            //do the check\n            var text = that.controls.selftranscript.val();\n            //but quit if its empty\n            if(!text || text==='' || text.trim()===''){\n                return;\n            }\n            //clear the existing TTS markup\n            that.controls.ttssentencecont.empty();\n\n            //split the text into sentences\n            var sentences = text.split(/[\\.\\!\\?¿¡\\.\\.\\.;]/);\n            var slowspeed=1;\n            for (var i=0; i<sentences.length; i++){\n                var audiourl = polly.fetch_polly_url(sentences[i],slowspeed,'Amy');\n                templates.render('mod_solo/ttssentence',\n                    {sentence: sentences[i], audiourl: audiourl, sentenceindex: i}).then(\n                    function(html,js){\n                        //that.controls.player.html(html);\n                        templates.appendNodeContents(that.controls.ttssentencecont, html, js);\n                    }\n                );\n            }\n        }\n\n    };//end of return value\n});"],"names":["define","$","log","str","templates","polly","debug","controls","checking","init","uniqid","ready","thesentence_number","lettered","stoporpause","sentenceselector","this","init_strings","register_controls","register_events","init_polly","that","get_string","done","s","token","ttspassagecont","attr","region","showttspassagebtn","selftranscript","ttssentencecont","aplayer","theaplayerbtn","textblock","fa","passagelines","click","e","markup_and_show","addEventListener","length","doplayaudio","dehighlight_all","removeClass","addClass","removeAttr","paused","ended","play","pause","load","on","sentenceindex","highlight_sentence","thesentence","data","text","val","trim","empty","sentences","split","i","audiourl","fetch_polly_url","render","sentence","then","html","js","appendNodeContents"],"mappings":"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"}