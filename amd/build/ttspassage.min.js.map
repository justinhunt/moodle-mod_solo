{"version":3,"file":"ttspassage.min.js","sources":["../src/ttspassage.js"],"sourcesContent":["define(['jquery','core/log','core/str','core/templates','mod_solo/definitions','mod_solo/pollyhelper'], function($,log,str,templates,def,polly) {\n    \"use strict\"; // jshint ;_;\n\n\n    log.debug('Solo TTS Passage: initialising');\n\n    var app = {\n        //controls\n        controls: {},\n        checking: '... checking ...',\n\n        //init the module\n        init: function(uniqid){\n            this.uniqid=uniqid;\n            this.ready=false;\n            this.thesentence_number =0;\n            this.stoporpause='pause';\n            this.voice=\"Amy\";//default voice\n            \n            //common selectors\n            this.sentenceselector = '#' + this.uniqid + '_ttssentencecont span.tbr_sentence';\n            \n            //init other stuff\n            this.init_strings();\n            this.register_controls();\n            this.register_events();\n            this.init_polly();\n        },\n\n        init_strings: function(){\n            var that =this;\n            //not used here .. just for later use\n            str.get_string('checking','mod_solo').done(function(s){that.checking=s;});\n        },\n\n        init_polly: function(){\n            var token = this.controls.ttspassagecont.attr('data-token');\n            var region = this.controls.ttspassagecont.attr('data-region');\n            var owner = 'poodll';\n            var lang = this.controls.ttspassagecont.attr('data-ttslanguage');\n            var voices = def.voices[lang];\n            var randomIndex = Math.floor(Math.random() * voices.length);\n            this.voice = voices[randomIndex];\n            polly.init(token, region,owner);\n        },\n\n        //load all the controls so we do not have to do it later\n        register_controls: function(){\n            this.controls.ttspassagecont = $('#' + this.uniqid + '_ttspassageplayer');\n            this.controls.showttspassagebtn =  $('#' + this.uniqid + '_showttspassagebtn');\n            this.controls.selftranscript = $(\"textarea[name='selftranscript']\");\n            this.controls.ttssentencecont= $('#' + this.uniqid + '_ttssentencecont .tbr_innerdiv');\n            this.controls.ttssentencespinner= $('#' + this.uniqid + '_ttssentence_spinner');\n\n            \n            //audio player declarations\n            this.controls.aplayer = $('#' +  this.uniqid + '_ttspassageaudio');\n            this.controls.theaplayerbtn = $('#' +  this.uniqid + '_ttspassagebutton');\n            this.controls.textblock = $('#' +  this.uniqid + '_textblock');\n            this.controls.fa = $('#' +  this.uniqid + '_ttspassagebutton .fa');\n\n            //passage lines\n            this.controls.passagelines = $(this.sentenceselector);\n        },\n\n        //attach the various event handlers we need\n        register_events: function() {\n            var that = this;\n            that.controls.showttspassagebtn.click(function(e){\n                e.preventDefault();\n\n                if(!that.controls.ttspassagecont.is(':visible')) {\n                    //Quit if its empty\n                    var text = that.controls.selftranscript.val();\n                    if(!text || text==='' || text.trim()===''){\n                        return;\n                    }\n                    that.markup_and_show();\n                }\n                //show the widget\n                that.controls.ttspassagecont.toggle();\n            });\n\n            //AUDIO PLAYER events\n            that.controls.aplayer[0].addEventListener('ended', function(){\n                if(that.thesentence_number< that.controls.passagelines.length -1){\n                    that.thesentence_number++;\n                    that.doplayaudio(that.thesentence_number);\n                }else{\n                    that.dehighlight_all();\n                    that.controls.fa.removeClass('fa-stop');\n                    that.controls.fa.addClass('fa-volume-up');\n                    that.thesentence_number=0;\n                    that.controls.aplayer.removeAttr('src');\n                }\n            });\n\n            //handle audio player button clicks\n            that.controls.theaplayerbtn.click(function(){\n                that.controls.passagelines = $(that.sentenceselector);\n                if(!that.controls.aplayer[0].paused && !that.controls.aplayer[0].ended){\n                    log.debug('not paused and not ended');\n                    that.controls.aplayer[0].pause();\n                    if(that.stoporpause=='stop'){\n                        that.controls.aplayer[0].load();\n                        that.thesentence_number=0;\n                    }\n                    that.controls.fa.removeClass('fa-stop');\n                    that.controls.fa.addClass('fa-volume-up');\n\n                    //if paused and in limbo no src state\n                }else if(that.controls.aplayer[0].paused && that.controls.aplayer.attr('src')){\n                    log.debug('inlimbo');\n                    that.doplayaudio(that.thesentence_number);\n                    that.controls.fa.removeClass('fa-volume-up');\n                    that.controls.fa.addClass('fa-stop');\n                    //play\n                }else{\n                    log.debug('play');\n                    if(that.stoporpause=='stop'){\n                        that.thesentence_number=0;\n                    }\n                    that.doplayaudio(that.thesentence_number);\n                    that.controls.fa.removeClass('fa-volume-up');\n                    that.controls.fa.addClass('fa-stop');\n                }//end of if paused ended\n            });\n\n            //handle sentence clicks\n            $('#' + that.uniqid + '_ttssentencecont  .tbr_innerdiv').on('click', '.tbr_sentence',function(){\n                that.controls.aplayer[0].pause();\n                var sentenceindex = $(this).attr('data-sentenceindex');\n                that.controls.fa.removeClass('fa-volume-up');\n                that.controls.fa.addClass('fa-stop');\n                that.thesentence_number = sentenceindex;\n                that.doplayaudio(sentenceindex);\n            });\n\n            \n        },//end of register events\n\n        //FUNCTION:  unhighlight a sentence as active\n        dehighlight_all: function(){\n            this.controls.passagelines.removeClass('passageplayer_activesentence');\n        },\n\n        //FUNCTION:  highlight a sentence as active\n        highlight_sentence: function(thesentence){\n            this.controls.passagelines.removeClass('passageplayer_activesentence');\n            $(this.controls.passagelines[thesentence]).addClass('passageplayer_activesentence');\n            // $(sentenceselector + '[data-sentenceindex=' + thesentence + ']').addClass('passageplayer_activesentence');\n        },\n\n        //FUNCTION: play a single sentence and mark it active for display purposes\n        doplayaudio: function(thesentence){\n            log.debug(thesentence);\n            var audiourl = $(this.controls.passagelines[thesentence]).data('audiourl');\n            log.debug(audiourl);\n            this.highlight_sentence(thesentence);\n            this.controls.aplayer.attr('src',audiourl);\n            this.controls.aplayer[0].play();\n        },\n\n        markup_and_show: async function(){\n            var that = this;\n            //do the check\n            var text = that.controls.selftranscript.val();\n            //but quit if its empty\n            if(!text || text==='' || text.trim()===''){\n                return;\n            }\n            //clear the existing TTS markup\n            that.controls.ttssentencecont.empty();\n\n            //split the text into sentences\n            //this is like split but it returns the delimiters too\n            var sentences = text.match(/[^\\.\\!\\?¿¡\\.\\.\\.;]*[\\.\\!\\?¿¡\\.\\.\\.;]/g);\n            var slowspeed=1;\n            that.controls.ttssentencecont.empty();\n            //show spinner and hide sentences that are processing\n            that.controls.ttssentencespinner.show();\n            that.controls.ttssentencecont.hide();\n            for (var i=0; i<sentences.length; i++){\n                if(sentences[i].trim()===''){continue;}\n                var audiourl = await polly.fetch_polly_url(sentences[i],slowspeed,that.voice);\n                templates.render('mod_solo/ttssentence',\n                    {sentence: sentences[i], audiourl: audiourl, sentenceindex: i}).then(\n                    function(html,js){\n                        templates.appendNodeContents(that.controls.ttssentencecont, html, js);\n                    }\n                );\n            }\n            //hide spinner and show sentences\n            that.controls.ttssentencespinner.hide();\n            that.controls.ttssentencecont.show();\n        }\n\n    };//end of return value\n    return app;\n});"],"names":["define","$","log","str","templates","def","polly","debug","controls","checking","init","uniqid","ready","thesentence_number","stoporpause","voice","sentenceselector","this","init_strings","register_controls","register_events","init_polly","that","get_string","done","s","token","ttspassagecont","attr","region","lang","voices","randomIndex","Math","floor","random","length","showttspassagebtn","selftranscript","ttssentencecont","ttssentencespinner","aplayer","theaplayerbtn","textblock","fa","passagelines","click","e","preventDefault","is","text","val","trim","markup_and_show","toggle","addEventListener","doplayaudio","dehighlight_all","removeClass","addClass","removeAttr","paused","ended","pause","load","on","sentenceindex","highlight_sentence","thesentence","audiourl","data","play","async","empty","sentences","match","show","hide","i","fetch_polly_url","render","sentence","then","html","js","appendNodeContents"],"mappings":"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"}