{"version":3,"file":"cloudpoodll.min.js","sources":["../src/cloudpoodll.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * The CloudPoodll JS for loading recorders into iframe based on data-attributes on the container div\n *\n * @module     mod_solo/cloudpoodll\n * @copyright  2025 Justin Hunt <justin@poodll.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n/**\n * root is our root object context, ie. window if we are in a browser\n * factory is a method that builds and returns our module\n */\n(function(root, factory) {\n    // If AMD is available, use the define() method to load our dependencies\n    //and declare our module\n    if (typeof define === 'function' && define.amd) {\n        define([], function() {\n            return factory(root);\n        });\n    }\n    // Otherwise we will attach our module to root, and pass references to our\n    // dependencies into the factory. We're assuming that our dependencies are\n    // also attached to root here, but they could come from anywhere\n    else\n    {\n        root.CloudPoodll = factory(root);\n    }\n})(this, function(root) {\n    // This is our factory method. Return our module object here...\n    return {\n        version: '1.3.4',\n        baseURL: 'https://cloud.poodll.com/local/cpapi/fastpoodllloader.php',\n        params: ['parent','appid','timelimit','type','media','updatecontrol','width','height','id',\n            'iframeclass','transcode','transcoder','transcribe','subtitle','language','transcribevocab',\n            'expiredays','owner','region','token','localloader','localloading','notificationurl',\n            'sourcemimetype','speechevents','hints','alreadyparsed','fallback','cloudpoodllurl'],\n\n        setBaseUrl: function(cloudpoodllurl){\n            this.baseURL = cloudpoodllurl + '/local/cpapi/fastpoodllloader.php';\n        },\n\n        fetchContainers: function(classname){\n            var divs = document.getElementsByClassName(classname);\n            return divs;\n        },\n        autoCreateRecorders: function(classname){\n            if(!classname){classname='cloudpoodll';}\n            var containers = this.fetchContainers(classname);\n            for(var ctr=0;ctr<containers.length;ctr++){\n                this.insertRecorder(containers[ctr]);\n            }\n        },\n        createRecorder: function(elementid){\n            var theelement=document.getElementById(elementid);\n            this.insertRecorder(theelement);\n        },\n\n        insertRecorder: function(container, attributes){\n            if(attributes == undefined) {\n                attributes = this.parseAttributes(container);\n            }\n            var iframe = this.createIframe(attributes);\n            if(iframe) {\n                container.appendChild(iframe);\n                container.setAttribute('data-alreadyparsed','true');\n            }\n        },\n        parseAttributes: function(container){\n            var attributes = {};\n            for(var i=0;i<this.params.length;i++){\n                var attr = container.getAttribute('data-' + this.params[i]);\n                if(attr!==null){\n                    attributes[this.params[i]]=attr;\n                }\n            }\n            return attributes;\n        },\n        createIframe: function(attributes){\n\n            //cancel out if this div was already processed\n            if(attributes.hasOwnProperty('alreadyparsed') ){\n                if(attributes['alreadyparsed']=='true'){\n                   // console.log(\"Can only parse a cloudpoodll element once. Cancelling.\");\n                    return false;\n                }\n            }\n\n            //CloudPoodllURL\n            if(attributes.hasOwnProperty('cloudpoodllurl') ){\n                this.setBaseUrl(attributes['cloudpoodllurl']);\n            }\n            \n            //fix up default attributes if the user did not set them\n            //parent\n            if(!attributes.hasOwnProperty('parent') ){\n                attributes['parent']=window.location.protocol + '//' + window.location.hostname;\n            }\n            //media\n            if(!attributes.hasOwnProperty('media') ){\n                attributes['media']='audio';\n            }\n            //also store predicted mimetype\n            attributes['sourcemimetype'] = this.guess_mimetype(attributes['media'],attributes['transcribe'],attributes['hints']);\n\n            //build and set the iframe src url\n            var iframe = document.createElement('iframe');\n\n            //set up the base URL for the iframe\n            //if we need and can load locally from html we do that\n            if(!attributes.hasOwnProperty('localloader')){\n                var localloading = 'never';\n            }else {\n                var localloading = attributes.hasOwnProperty('localloading') ? attributes['localloading'] : 'auto';\n            }\n\n            switch(localloading){\n\n                case 'always':\n                    var iframeurl = attributes['parent'] + attributes['localloader'] + '?cloudpoodllurl=' + attributes['cloudpoodllurl'] + '&';\n                    break;\n\n                case 'never':\n                    var iframeurl = this.baseURL + '?';\n                    break;\n\n                case 'auto':\n                default:\n                    var isIOS_safari = this.is_ios() || this.is_safari();\n                    if(isIOS_safari) {\n                        var iframeurl = attributes['parent'] + attributes['localloader'] + '?cloudpoodllurl='  + attributes['cloudpoodllurl'] + '&';\n                    }else {\n                        var iframeurl = this.baseURL + '?';\n                    }\n                    break;\n            }\n\n            //build iframeurl based on baseurl and attributes\n            for (var property in attributes) {\n                iframeurl = iframeurl + property + '=' + attributes[property] + '&';\n            }\n            iframe.setAttribute('src', iframeurl);\n\n            //do any iframe attributes that we need to\n            //width and height (only if no iframe class specified)\n            //see here for responsive iframe ..https://blog.theodo.fr/2018/01/responsive-iframes-css-trick/\n            if(attributes.hasOwnProperty('iframeclass')) {\n                iframe.setAttribute('class', attributes.iframeclass);\n            }else{\n                if(!attributes.hasOwnProperty('width') ){\n                    attributes['width']=350;\n                }\n                iframe.setAttribute('width', attributes.width);\n                if(!attributes.hasOwnProperty('height') ){\n                    if(attributes['media']=='audio') {\n                        attributes['height'] = 250;\n                    }else{\n                        attributes['height'] = 550;\n                    }\n                }\n                iframe.setAttribute('height', attributes.height);\n            }\n            iframe.setAttribute('frameBorder', 0);\n            iframe.setAttribute('allow', 'camera; microphone; display-capture');\n            return iframe;\n        },\n        theCallback: function(data) {\n            switch(data.type){\n                case 'filesubmitted':\n                    var inputControl = data.updatecontrol;\n                    var pokeInput = document.getElementById(inputControl);\n                    var theurl = data.mediaurl;\n                    if (pokeInput) {\n                        pokeInput.value = theurl;\n                    }\n                    break;\n                case 'error':\n                    alert('ERROR:' . data.message);\n            }\n        },\n        initEvents: function(){\n            var that = this;\n            window.addEventListener('message', function(e) {\n                var data = e.data;\n                if (data && data.hasOwnProperty('id') && data.hasOwnProperty('type')){\n                    that.theCallback(data);\n                }\n            });\n        },\n        sendMessage: function(containerid,messageObject){\n\n            if(!messageObject.hasOwnProperty('type')){\n                //'All message objects must have at least the \"type\" property'\n                return;\n            }\n\n            var theiframe = document.getElementById(containerid).getElementsByTagName('iframe')[0];\n\n            //messageObject.id = this.id;\n            theiframe.contentWindow.postMessage(messageObject);\n\n        },\n        fetchroot: function(){\n            return root;\n        },\n\n        is_safari: function(){\n            return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\n        },\n\n        is_ios: function(){\n            return  /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;\n        },\n\n        guess_mimetype: function(mediatype, transcribe, hints){\n\n            //if we are using Google Cloud Speech Transcribe then we only support audio/wav\n            if(transcribe==2){\n                return \"audio/wav\";\n            }\n            //this is a bit hacky, we should base64decode hints and look for the value of hints.encoder\n            if(hints && hints.includes('stereoaudio')){\n                return \"audio/wav\";\n            }\n\n            var nVer = navigator.appVersion;\n            var nAgt = navigator.userAgent;\n            var browserName  = navigator.appName;\n            //decided no real benefit and some danger in detecting version, so commented it mostly\n            var fullVersion  = ''+parseFloat(navigator.appVersion);\n            var nameOffset,verOffset,ix;\n\n            if(nAgt.match('(?:Edge|EdgA|EdgiOS)')!==null) {\n                browserName=\"Edge\";\n                //dont know how to get this and its probably not important yet\n                //fullVersion = '1.0';\n\n            // In Opera, the true version is after \"Opera\" or after \"Version\"\n            }else if ((verOffset=nAgt.indexOf(\"Opera\"))!=-1) {\n                browserName = \"Opera\";\n                //fullVersion = nAgt.substring(verOffset+6);\n                //if ((verOffset=nAgt.indexOf(\"Version\"))!=-1) fullVersion = nAgt.substring(verOffset+8);\n            }\n            // In MSIE, the true version is after \"MSIE\" in userAgent\n            else if ((verOffset=nAgt.indexOf(\"MSIE\"))!=-1) {\n                browserName = \"IE\";\n                //fullVersion = nAgt.substring(verOffset+5);\n            }\n            // In Chrome, the true version is after \"Chrome\"\n            else if ((verOffset=nAgt.indexOf(\"Chrome\"))!=-1) {\n                browserName = \"Chrome\";\n                //fullVersion = nAgt.substring(verOffset+7);\n            }\n            // In Safari, the true version is after \"Safari\" or after \"Version\"\n            else if ((verOffset=nAgt.indexOf(\"Safari\"))!=-1) {\n                browserName = \"Safari\";\n                //fullVersion = nAgt.substring(verOffset+7);\n                //if ((verOffset=nAgt.indexOf(\"Version\"))!=-1)fullVersion = nAgt.substring(verOffset+8);\n            }\n            // In Firefox, the true version is after \"Firefox\"\n            else if ((verOffset=nAgt.indexOf(\"Firefox\"))!=-1) {\n                browserName = \"Firefox\";\n                //fullVersion = nAgt.substring(verOffset + 8);\n                // In most other browsers, \"name/version\" is at the end of userAgent\n            }else if ( (nameOffset=nAgt.lastIndexOf(' ')+1) <\n                (verOffset=nAgt.lastIndexOf('/')) )\n            {\n                browserName = nAgt.substring(nameOffset,verOffset);\n                //fullVersion = nAgt.substring(verOffset+1);\n                if (browserName.toLowerCase()==browserName.toUpperCase()) {\n                    browserName = navigator.appName;\n                }\n            }\n\n\n            //OS detection\n            var OS = \"Unknown OS\";\n            if (navigator.userAgent.indexOf(\"Win\") != -1){OS = \"Windows\";}\n            if (navigator.userAgent.indexOf(\"Mac\") != -1) {OS = \"Macintosh\";}\n            if (navigator.userAgent.indexOf(\"Linux\") != -1){OS = \"Linux\";}\n            if (navigator.userAgent.indexOf(\"Android\") != -1){OS = \"Android\";}\n            if (navigator.userAgent.indexOf(\"like Mac\") != -1) {OS = \"iOS\";}\n\n\n            var browser={};\n            browser.name=browserName;\n            browser.version=fullVersion;\n            browser.OS=OS;\n\n            //predicted mimetype\n            var mimetype=\"unsupported/unsupported\";\n            if(mediatype=='video'){\n                switch(browser.name){\n                    case 'Edge':\n                    case 'MSIE':\n                        mimetype=\"video/webm\";\n                        break;\n                    case 'Safari':\n                        mimetype=\"video/quicktime\";\n                        //new mobile safari .. but how to detect?\n                        //mimetype=\"video/mp4\";\n                        break;\n                    case 'Firefox':\n                    case 'Chrome':\n                    case 'Opera':\n                    default:\n                        mimetype=\"video/webm\";\n                }\n            }else{\n                switch(browser.name){\n                    case 'MSIE':\n                        mimetype=\"audio/wav\";\n                        break;\n                    case 'Safari':\n                        mimetype=\"audio/wav\";\n                        //new mobile safari ... but how do we know?\n                        mimetype=\"audio/mpa\";\n                        break;\n                    case 'Firefox':\n                        mimetype=\"audio/ogg\";\n                        break;\n                    case 'Chrome':\n                    case 'Opera':\n                    case 'Edge':\n                    default:\n                        mimetype=\"audio/webm\";\n                }\n            }\n            /*\n            document.write(''\n                +'Browser name  = '+browser.name+'<br>'\n                +'Full version  = '+browser.version+'<br>'\n                +'OS  = '+browser.OS+'<br>'\n                +'mimetype  = '+mimetype+'<br>'\n            )\n            */\n            return mimetype;\n        }//end of guess mimetype\n    };//end of returned object (poodllcloud)\n});//end of factory method container"],"names":["root","factory","this","version","baseURL","params","setBaseUrl","cloudpoodllurl","fetchContainers","classname","document","getElementsByClassName","autoCreateRecorders","containers","ctr","length","insertRecorder","createRecorder","elementid","theelement","getElementById","container","attributes","undefined","parseAttributes","iframe","createIframe","appendChild","setAttribute","i","attr","getAttribute","hasOwnProperty","window","location","protocol","hostname","guess_mimetype","createElement","localloading","iframeurl","is_ios","is_safari","property","iframeclass","width","height","theCallback","data","type","inputControl","updatecontrol","pokeInput","theurl","mediaurl","value","alert","message","initEvents","that","addEventListener","e","sendMessage","containerid","messageObject","getElementsByTagName","contentWindow","postMessage","fetchroot","test","navigator","userAgent","MSStream","mediatype","transcribe","hints","includes","appVersion","nameOffset","verOffset","nAgt","browserName","appName","fullVersion","parseFloat","match","indexOf","lastIndexOf","substring","toLowerCase","toUpperCase","OS","browser","name","mimetype","define","amd","CloudPoodll"],"mappings":"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"}